name: Plugin Tests

on:
  push:
    branches:
      - main
    paths:
      - 'src/plugin/**'
      - 'src/render_plugins.sh'
      - 'src/utils.sh'
      - 'src/cache.sh'
      - '.github/workflows/plugin-tests.yml'
  pull_request:
    paths:
      - 'src/plugin/**'
      - 'src/render_plugins.sh'
      - 'src/utils.sh'
      - 'src/cache.sh'
  workflow_dispatch:

jobs:
  test-plugins:
    name: Test Plugins
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: false

      - name: Install tmux
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y tmux
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install tmux
          fi

      - name: Verify plugin scripts syntax
        run: |
          set -e
          for plugin in src/plugin/*.sh; do
            echo "Testing syntax: $plugin"
            bash -n "$plugin"
          done

      - name: Test plugin rendering (dry run)
        run: |
          set -e
          export TMUX_TOKYO_NIGHT_STYLE="night"
          
          # Source utilities
          source src/utils.sh
          source src/cache.sh
          source src/separators.sh
          
          # Test each plugin can be sourced and loaded
          for plugin in src/plugin/*.sh; do
            echo "Testing plugin: $plugin"
            source "$plugin" || {
              echo "Failed to source $plugin"
              exit 1
            }
          done

      - name: Test OS detection
        run: |
          set -e
          source src/utils.sh
          
          # Test get_os_icon function
          os_icon=$(get_os_icon)
          echo "Detected OS icon: $os_icon"
          
          if [[ -z "$os_icon" ]]; then
            echo "OS icon detection failed"
            exit 1
          fi
          
          echo "OS detection test passed"

      - name: Test available plugins on ${{ matrix.os }}
        run: |
          set -e
          source src/utils.sh
          
          # Test conditional plugins based on OS
          echo "Testing conditional plugin availability..."
          
          # These should work on all platforms
          for plugin in datetime hostname uptime cpu memory disk; do
            plugin_file="src/plugin/${plugin}.sh"
            if [[ -f "$plugin_file" ]]; then
              echo "✓ Plugin available: $plugin"
            else
              echo "✗ Plugin missing: $plugin"
              exit 1
            fi
          done
          
          # OS-specific plugins
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "Testing macOS-specific plugins..."
            # Test that temperature is properly disabled
            if grep -q "darwin" src/plugin/temperature.sh 2>/dev/null; then
              echo "✓ Temperature plugin has macOS handling"
            fi
          fi
          
          echo "Plugin availability test passed"
